#
# Makefile : service required 12
#

# Check all necessary environment variables
-include ../../env.check.mk

# export ARCH environment variable
export ARCH ?= $(shell hzn architecture)

# Import variables from hzn.json (file is generated by last target in this file)
-include .hzn.json.tmp.mk

# Publish a Horizon service (per service.definition.json) and pull image to get its sha256
publish-service:
	hzn exchange service publish -f horizon/service-definition.json --pull-image

publish-pattern:
	hzn exchange pattern publish -f horizon/pattern-service.json

# Add a service policy for the Horizon service 
add-service-policy:
	hzn exchange service addpolicy -f horizon/service-policy.json "$(SERVICE_NAME)_$(SERVICE_VERSION)_$(ARCH)"

# Add a deployment policy for the Horizon service 
add-deploy-policy:
	hzn exchange deployment addpolicy -f horizon/deploy-policy.json deploy-$(EDGE_OWNER).$(EDGE_DEPLOY).$(IMAGE_NAME)_$(ARCH)

register:
	hzn register -p "${HZN_ORG_ID}/pattern-${SERVICE_NAME}"

# Test application service 
test-app-service:
	curl http://localhost:8881 | jq
	curl http://localhost:8882 | jq

# Test unregister the Edge device node
unregister:
	hzn unregister -rfD

# This imports the variables from hzn.json
.hzn.json.tmp.mk: horizon/hzn.json
	@ hzn util configconv -f $< > $@

