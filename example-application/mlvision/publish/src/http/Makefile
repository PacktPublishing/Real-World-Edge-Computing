#
# Makefile : http : A flask based local http server for UI
#

# Check all necessary environment variables
-include ../../env.check.mk

export ARCH ?= $(shell hzn architecture)

# Import variables from hzn.json (file is generated by last target in this file)
-include .hzn.json.tmp.mk

all: build push publish-service

# Build the docker container
build:
	docker build -t $(DOCKER_IMAGE_BASE)_$(ARCH):$(SERVICE_VERSION) -f ./Dockerfile.$(ARCH) .

# Push the docker container to the DockerHub registry
push:
	docker login -u $(CR_USERNAME) -p $(CR_DOCKER_APIKEY) $(CR_HOST)
	docker push $(DOCKER_IMAGE_BASE)_$(ARCH):$(SERVICE_VERSION)

# Publish a Horizon service (per service.json) and pull image to get its sha256
publish-service:
	docker login -u $(CR_USERNAME) -p $(CR_DOCKER_APIKEY) $(CR_HOST)
	hzn exchange service publish -O -f horizon/service-definition.json --pull-image -r "$(CR_HOST):$(CR_USERNAME):$(CR_DOCKER_APIKEY)" 

# This imports the variables from hzn.json
.hzn.json.tmp.mk: horizon/hzn.json
	@ hzn util configconv -f $< > $@

